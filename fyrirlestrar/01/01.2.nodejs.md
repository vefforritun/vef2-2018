
# Fyrirlestur 1.2 ‚Äî node.js
### Vefforritun 2 ‚Äî HBV403G
#### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## Node.js

* B√∫i√∞ til af Ryan Dahl og [fyrst gefi√∞ √∫t 2009](http://www.youtube.com/watch?v=ztspvPYybIY)
* Vildi b√∫a til vef sem s√Ωndi framgang me√∞an skr√° var hla√∞i√∞ upp √° vef√æj√≥n
* Ger√∞i tilraunir me√∞ C, Lua og Haskell en me√∞ √∫tg√°fu V8 var√∞ JavaScript fyrir valinu

***

## Node.js

* Verkvangur (platform) bygg√∞ur √° V8 til a√∞ sm√≠√∞a hr√∂√∞, skalanleg netforrit
* Notar atbur√∞adrifi√∞, ekki-blokkandi I/O m√≥del sem gerir √æa√∞ l√©tt, skilvirkt og fullkomi√∞ fyrir raunt√≠ma forrit sem me√∞h√∂ndla mikil g√∂gn yfir dreif√∞ kerfi
 Notum til a√∞ b√∫a til allskonar forrit, b√¶√∞i _bakenda_, _CLI_ o.fl.

***

## Node.js

* Ekki forritunarm√°l, JavaScript er forritunarm√°li√∞ sem node notar
  - Samle√∞gar√°hrif me√∞ framenda, _eitt m√°l fyrir framenda og bakenda_ getur heilla√∞
  - Samt **ekki** sama keyrsluumhverfi√∞!
* Ekki framework (einsog t.d. Rails e√∞a Django) en getur veri√∞ nota√∞ til a√∞ b√∫a √æannig til

***

## V8

* [V8 er Open source JavaScript v√©l](https://developers.google.com/v8/), h√∂nnu√∞ af Google fyrir Chrome
* Skrifu√∞ √≠ C++ og √∫tf√¶rir st√≥ran part af ECMAScript 6
* √û√Ω√∞ir JavaScript √≠ v√©lam√°l fyrir keyrslu √≠ sta√∞inn fyrir a√∞ t√∫lka
* √ùmsar bestunar a√∞fer√∞ir keyr√∞ar √° √æ√Ωddan k√≥√∞a
* Keyrir JavaScript _hratt_

***

## Node.js

* Beislar kraft V8 me√∞ √æv√≠ a√∞ skrifa lag ofan √° √æa√∞
* Kjarninn √≠ node.js reynir a√∞ vera einfaldur
  - H√∂fum a√∞gerir fyrir skr√°arkerfi, networking, st√Ωrikerfi og nokkra a√∞ra hluti
* Mj√∂g gott pakkakerfi, NPM, sty√∞ur vi√∞ √æetta
  - Fl√≥knari hlutir √∫tf√¶r√∞ir √≠ p√∂kkum

***

## √ötg√°fur

* Node var lengi vel a√∞ keyra √° √∫tg√°fum 0.x
  - st√∂√∞ugar √∫tg√°fur fyrir jafnar t√∂lur (t.d. 0.10) en √≥st√∂√∞ugar fyrir odda t√∂lur (t.d. 0.11)
* √ûetta m√≥del var tilt√∂lulega h√¶gt, n√Ω virkni t√≥k langan t√≠ma a√∞ komast √≠ st√∂√∞uga √∫tg√°fu, og vegna √æess (√°samt √∂√∞rum √°st√¶√∞um) var [io.js](https://iojs.org) fork af node.js ger√∞ur √≠ desember 2014
  - io.js merga√∞ aftur inn √≠ node √≠ ma√≠ 2015
* N√∫verandi st√∂√∞uga √∫tg√°fa er 8.9.x, √∫tg√°fa 9.4.x er me√∞ n√Ωjustu virkni

***

## node og ECMAScript 6

* N√Ωjustu √∫tg√°fur af node hafa [99% stu√∞ning vi√∞ ECMASCript 6](http://node.green/)
* Getum √æv√≠ nota√∞ allt n√Ωja d√≥ti√∞ √°n √æess a√∞ _transpilea_ √° _server_
* Fyrir enn n√Ωrri virkni (ECMAScript 2016+) getum vi√∞ √æ√≥ sett upp Babel (e√∞a √°l√≠ka) og _transpilea√∞_

***

## Uppsetning

* Au√∞velt a√∞ setja upp, stu√∞ningur vi√∞ Linux, Mac og Windows
  - http://nodejs.org/download
* NPM fylgir me√∞

***

## Margar √∫tg√°fur af node √≠ einu

* √ötg√°fur af node koma frekar √∂rt √∫t
* Getum keyrt margar √∫tg√°fur √≠ einu me√∞ t√≥lum
* [nvm](https://github.com/creationix/nvm) (mac og linux) e√∞a [nvm-windows](https://github.com/coreybutler/nvm-windows)
  - node version manager

***

## node √∫tg√°fa og package.json

* Getum tilgreint hva√∞a √∫tg√°fur af node vi√∞ skrifum forritin okkar fyrir √≠ `package.json`
* [`"engines"`](https://docs.npmjs.com/files/package.json#engines) lykill er hlutur me√∞ lyklum, t.d. `node` og streng sem skilgreinir √∫tg√°fu, t.d. `>=8 <10`
  - `"engines": { "node": ">=8 <10" }`
  - node √∫tg√°fur 8 og 9, ekki 10

***

## Node binary og REPL

* √ûegar vi√∞ h√∂fum sett upp Node f√°um vi√∞ a√∞gang a√∞ `node` √≠ skel
  - Keyrum forritin okkar me√∞ `node forrit.js`
* Ef vi√∞ keyrum √°n √æess a√∞ v√≠sa √≠ skjal f√°um vi√∞ a√∞gang a√∞ REPL
  ‚Äì Read-Eval-Print Loop
  - Skel fyrir Node.js sem getur veri√∞ mj√∂g hj√°lpleg √≠ a√∞ pr√≥fa okkur √°fram e√∞a debugga k√≥√∞a
* H√¶ttum √≠ REPL, e√∞a st√∂√∞vum keyrslu √° forriti me√∞ `CTRL+C` sem sendir `SIGINT` √° keyrslu

***

## REPL d√¶mi

```
$ node
> foo = 1
1
> _ + 2     (_ seinasta skilagildi)
3
> .help
```

***

## Atbur√∞adrifi√∞

* Node.js forrit eiga a√∞ vera atbur√∞adrifin ‚Äì erfitt a√∞ skrifa √æau ekki √æannig
* Gefum upp _callback_ fall fyrir hluti sem taka t√≠ma, kalla√∞ √≠ √æa√∞ √æegar a√∞ger√∞ kl√°rast
* Allar a√∞ger√∞ir √≠ core sem gera eitthva√∞ √≠ lengri t√≠ma taka vi√∞ callback

***

## Atbur√∞adrifi√∞

* Node.js er sj√°lfgefi√∞ keyrt √≠ __einum process__, √æar sem CPU er yfirleitt ekki √æa√∞ sem takmarkar
  - Notum ekki √ær√¶√∞i fyrir okkar k√≥√∞a, √æ√≥ √æeir s√©u nota√∞ir innan node
  - Notum event loop sem heldur utan um allt sem gera √æarf
* √û.a. ef vi√∞ blokkum‚Äîb√≠√∞um eftir I/O, minni, neti o.sfr.‚Äî√æ√° blokkar allt node.js keyrsluumhverfi√∞
* Svo lengi sem eitthva√∞ er √° event loop, keyrir node, annars h√¶ttir forrit

***

## libuv

* √ç fyrstu var node.js skrifa√∞ me√∞ libev sem √∫tf√¶rir event loopu, en √æa√∞ er a√∞eins fyrir Unix
* [libuv](http://docs.libuv.org/) er √∫tf√¶rsla sem keyrir √° m√∂rgum st√Ωrikerfum og f√≥kusar √° asynchronous (√≥samfasa) I/O
* Node.js gar √æar me√∞ keyrt √° Windows
* Or√∞i√∞ nokku√∞ √æroska√∞ verkefni og nota√∞ af fleirum √≠ dag

***

![Event loop](img/eventloop.svg)

***

## Forrit sem keyrir endalaust

```
setInterval(() => console.log('h√¶'), 1000);
```

***

## Blokk

```
setTimeout(() => {
  console.log('Finished@' + new Date().toTimeString());
}, 1000);

const s = new Date();
console.log('Start@' + s.toTimeString());

let i = 0;
const iterateForInMs = 10;
while(new Date().getTime() < s.getTime() + iterateForInMs) {
   i++;
}
console.log('Exit@' + new Date().toTimeString());
console.log(i + ' iterations.');
```

http://book.mixu.net/node/ch2.html

---

## console

* H√∂fum `console` alltaf a√∞gengilegt l√≠kt og √≠ vafra til a√∞ skrifa √≠ `stdout` og `stderr`
* `console.log()` - skrifar √≠ `stdout` me√∞ newline
* `console.error()` - eins, en skrifar √≠ `stderror`
* `console.time(label)` - byrjar timer undir `label`
* `console.timeEnd(label)` - endar timer og skrifar hve lengi virkur

***

```
console.log('hall√≥ heimur');
console.error('villa!');
```

```
> node log.js > output.txt 2> error.txt
```

***

## Global breytan process

* √ç vafra h√∂fum vi√∞ `window`
* √ç Node.js h√∂fum vi√∞ [`process`](https://nodejs.org/api/process.html)
* Gefur okkur a√∞gang a√∞ uppl√Ωsingum um umhverfi og f√∂llum tengdum √æv√≠

***

## process d√¶mi

* [`process.exit([code])`](https://nodejs.org/api/process.html#process_process_exit_code) h√¶ttir keyrslu forrits me√∞ [gefnum k√≥√∞a](https://en.wikipedia.org/wiki/Exit_status), `0` √æ√Ω√∞ir a√∞ forrit keyr√∞i √°n villu, st√¶rri en `0` a√∞ villa hafi komi√∞ upp
* [`process.argv`](https://nodejs.org/api/process.html#process_process_argv) gefur uppl√Ωsingum um hvernig kalla√∞ var √° forrit og √∂ll arguments sem send voru
* [`process.hrtime()`](https://nodejs.org/api/process.html#process_process_hrtime_time) gefur a√∞gang a√∞ h√°skerpu klukku (nan√≥sek) sem vi√∞ getum nota√∞ til a√∞ taka t√≠ma √° forritum

***

## hrtime

```
const time = process.hrtime();
setTimeout(() => {
  const diff = process.hrtime(time);
  const elapsed = diff[0] * 1e9 + diff[1];

  console.log(`Took ${elapsed} nanoseconds`);
  console.log(`Took ${elapsed/1e6} milliseconds`);
  console.log(`Took ${elapsed/1e9} seconds`);
}, 1000);
```

***

## Debugger

* Getur veri√∞ erfitt a√∞ debugga event drifin k√≥√∞a, svipa√∞ og √≠ vafra
* Getum nota√∞ V8 debugging me√∞ √æv√≠ a√∞ setja `debugger;` √≠ k√≥√∞a
* Keyrum me√∞ `node debug` og f√°um √æ√° gdb-l√≠kt vi√∞m√≥t til a√∞ debugga
* Au√∞velt a√∞ keyra debugger √≠ [Visual Studio Code](https://code.visualstudio.com/)

***

## Buffer

* JavaScript hefur ekki g√≥√∞a lei√∞ til a√∞ vinna me√∞ binary g√∂gn
* [`Buffer`](https://nodejs.org/api/buffer.html) er global gildi sem vi√∞ getum nota√∞ til a√∞ vinna me√∞ hr√° g√∂gn sem geymd eru utan V8 heap
* √ûegar vi√∞ breytum milli Buffer og JavaScript string, √æurfum vi√∞ a√∞ tilgreina enk√≥√∞un, t.d. `ascii`, `utf8`, `latin1`
  - `buffer.toString('utf8');`

***

## util

* √ùmis hj√°lparf√∂ll √≠ bo√∞i √≠ `util` module
* [`util.format()`](https://nodejs.org/api/util.html#util_util_format_format_args) - `printf`-leg strengja me√∞h√∂ndlun
* [`util.inherits(constructor, superContstructor)`](https://nodejs.org/api/util.html#util_util_inherits_constructor_superconstructor) - erfir pr√≥t√≥t√Ωpu fr√° super √≠ n√Ωjan hlut en √¶ttum samt frekar a√∞ nota ES6 `class`
* [`util.promisify()`](https://nodejs.org/api/util.html#util_util_promisify_original) ‚Äì n√Ωtt √≠ √∫tg√°fu 8, breytir callback API √≠ promise API

***

## Filesystem

* Node.js getur tala√∞ vi√∞ skr√°arkerfi√∞ og gert √æa√∞ sem vi√∞ b√∫umst vi√∞ me√∞ [`fs`](https://nodejs.org/api/fs.html) module
  - Lesa skr√°r √≠ m√∂ppu, lesa skr√°r, b√∫a til skr√°r, vista skr√°r o.fl.
  - Skilar g√∂gnum √≠ `Buffer`
* `fs.readFile(file, encoding, callback)` les skr√°
* `fs.writeFile(file, data, callback)` skrifar skr√°

***

## Ekki-blokkandi I/O ‚Äì Async I/O

* I/O er √≥tr√∫lega h√¶gt m.v. anna√∞ sem vi√∞ gerum
* √ûegar vi√∞ bi√∞jum um I/O √≠ node.js sendum vi√∞ atbur√∞i sem ver√∞a keyr√∞ir √æegar st√Ωrikerfi er b√∫i√∞
* √ûurfum √æv√≠ ekki a√∞ b√≠√∞a! Gerum eitthva√∞ nytsamlegt √° me√∞an

***

## Async I/O - d√¶mi

```
const fs = require('fs');

fs.readFile('data.txt', (err, data) => {
  if (err) {
    console.error('error', err);
  } else {
    console.log(data);
  }
});
```

***

## Callbacks

* Lang flest API √≠ node.js taka vi√∞ callbacks √° forminu
  - `function (err, data) { }`
* Ef villa kom upp er `err` `truthy` og inniheldur uppl√Ωsingar um villu
* Annars eru ni√∞urst√∂√∞ur √≠ `data`
* N√Ωtum okkur fyrir √≥samfasa (async) a√∞ger√∞ir‚Äîevent loop tekur vi√∞ bei√∞ni um a√∞ger√∞, s√©r um b√≥khald og √æegar b√∫i√∞, kallar √≠ callback
* √ûurfum a√∞ hugsa _√≥l√≠nulega_ um fl√¶√∞i√∞ √≠ forritunum okkar

***

## L√≠nulegt fl√¶√∞i

```
let num = 1;
function addOne() { num++; }
addOne();
console.log(num);
```

***

## L√≠nulegt fl√¶√∞i ‚Äì bila√∞

```
const fs = require('fs');
let num;

function addOne() {
  // number.txt inniheldur "1"
  fs.readFile('number.txt', (err, fileContents) => {
    num = parseInt(fileContents, 10);
  });
}

addOne();

console.log(num);
```

***

## Callback fl√¶√∞i

```
const fs = require('fs');
let num;

function addOne(callback) {
  fs.readFile('number.txt', 'utf8', (err, fileContents) => {
    num = parseInt(fileContents, 10);
    num = num + 1;
    callback(num);
  });
}

addOne(num => {
  console.log(num)
});
```

***

## [_Callback hell_](http://callbackhell.com/)

* Ef vi√∞ framkv√¶mum margar async a√∞ger√∞ir hverja √° eftir annari, f√∂rum vi√∞ a√∞ dragast √≥√æarflega langt til h√¶gri
* Getum for√∞ast me√∞ √æv√≠ a√∞:
  - nota ekki nafnlaus f√∂ll √≠ callbacks
  - halda k√≥√∞anum grunnum
  - skipta k√≥√∞a upp √≠ m√≥d√∫la
  - nota _promises_
  - nota _async_ og _await_

http://callbackhell.com/

***

## Promises

* node hefur stu√∞ning vi√∞ promises sem gerir √æa√∞ au√∞veldara a√∞ vinna me√∞ async k√≥√∞a
* Fr√° og me√∞ √∫tg√°fu 8 getum vi√∞ nota√∞ `util.promisify` til a√∞ breyta callback API √≠ promise API
  - üòç

***

## util.promisify

```
const util = require('util');
const fs = require('fs');

const readFileAsync = util.promisify(fs.readFile);

readFileAsync('data.txt')
  .then(data => {
    console.log(data.toString('utf8'));
  })
  .catch(err => {
    console.error(err);
  });
```

***

## async og await

* Fr√° og me√∞ √∫tg√°fu 7.6 hefur node stutt `async` og `await`
* Enn √∂nnur lei√∞ til a√∞ vinna me√∞ async k√≥√∞a, kemur fr√° C#
* Notum `await` til a√∞ b√≠√∞a eftir promises √≠ f√∂llum og merkjum √æau f√∂ll me√∞ `async`

***

## async og await

* K√≥√∞inn okkar ver√∞ur t√∂luvert grynnri og l√¶silegri
* Notum `try catch` fyrir villume√∞h√∂ndlun
* `async` f√∂ll skila promises! √ûurfum a√∞ gr√≠pa yst, annars getum vi√∞ misst af villum

***

```
const util = require('util');
const fs = require('fs');

const readFileAsync = util.promisify(fs.readFile);

async function main() {
  let data = '';
  try {
    data = await readFileAsync('data.txt');
  } catch (e) {
    console.error('error', e);
  }
  console.log(data.toString('utf8'));
}

main().catch(err => { console.error(err); });
```

---

## NPM

* Heeeellingur til af NPM m√≥d√∫lum/p√∂kkum sem geta einfalda√∞ okkur l√≠fi√∞
* S√¶kjum me√∞ `npm install <module> --save` og tilgreinum √æannig a√∞ forriti√∞ okkar √æarfnist √æessa pakka
  - Skilgreinum _dependency_ √° pakkann
  - Vista√∞ √≠ `package.json` √°samt √∫tg√°fun√∫meri

***

## NPM pakkar

![NPM pakka samanbur√∞ur](img/www.modulecounts.com.png "Skj√°skot af modulescount.com √≠ jan√∫ar 2018")

http://www.modulecounts.com/

***

## npm install <module>

* Athugar NPM hver er n√Ωjasta √∫tg√°fa af `<module>`
* S√¶kir √∫tg√°funa
* Skilgreinir √∫tg√°fu n√∫mer √≠ `package.json`
* S√¶kir alla pakka sem `<module>` √æarf (og pakka sem √æeir pakka √æurfa o.s.fr.)
* Geymir alla pakka eins √∫tflatta og h√¶gt er √≠ `/node_modules`
* √ötb√Ωr `package-lock.json` me√∞ uppl√Ωsingum um alla pakka

***

![node_modules er me√∞ √æyngstu hlutum √≠ hinum √æekkta alheimi](img/node_modules_heavy.jpg "Mynd: http://i.imgur.com/W2P0Ul6.jpg")

***

## √ötg√°fun√∫mer

* NPM notar [_semantic versioning_](https://semver.org/) (semver) til a√∞ tilgreina √∫tg√°fun√∫mer `major.minor.patch`, t.d. `1.2.3`
  - `major` er h√¶kka√∞ ef vi√∞ gerum breytingar sem brj√≥ta API, t.d. breytum nafni √° falli
  - `minor` er h√¶kka√∞ ef vi√∞ b√¶tum vi√∞ virkni √°n √æess a√∞ brj√≥ta (backwards compatible)
  - `patch` er h√¶kka√∞ ef vi√∞ l√∂gum villur √°n √æess a√∞ brj√≥ta (backwards compatible)

***

## Hva√∞a √∫tg√°fu m√° NPM installa?

* NPM tilgreinir √∫tg√°fun√∫mer me√∞ _caret_ fyrir framan, t.d. `^1.2.3`
  - S√¶ttum okkur vi√∞ √∫tg√°fur sem h√¶kka ekki fyrsta ekki-0 t√∂lustaf lengst til vinstri, t.d. `^1.2.3` leyfir √∫tg√°fu `1.9.3` en ekki `2.0.0`
* Getum l√≠ka tilgreint _n√°kv√¶ma_ √∫tg√°fu me√∞ `1.2.3`
* og fleiri fl√≥knari reglur, sj√° [the semantic versionar for npm](https://docs.npmjs.com/misc/semver)

***

## H√¶ttur √æess a√∞ leyfa uppf√¶rslur

* Hugb√∫na√∞ur er (enn√æ√°!) skrifa√∞ur af f√≥lki og f√≥lk gerir mist√∂k
* A√∞ leyfa uppf√¶rslur √æegar NPM s√¶kir pakka _getur broti√∞ forritin okkar_, √æ√≥ √æa√∞ s√© _bara_ minor √∫tg√°fa
* G√≥√∞ regla a√∞ skilgreina n√°kv√¶mar √∫tg√°fur og uppf√¶ra me√∞vita√∞

***

## package-lock.json

* `package-lock.json` skilgreinir n√°kv√¶mar √∫tg√°fur af √∂llum p√∂kkum sem vi√∞ notum og p√∂kkum sem √æeir pakkar nota
* Leyfir √∂√∞rum a√∞ f√° _n√°kv√¶mlega_ s√∂mu √∫tg√°fu af keyrslu umhverfi og s√° sem skrifa√∞i
* Geymum √æv√≠ √≠ source control

***

## NPM √≥kostir?

* En hefur NPM √≥kosti?
* Seinustu √°r hafa komi√∞ upp atvik √æar sem pakkar hafa horfi√∞ √∫r NPM og haft √°hrif √° _√æ√∫sundir_ verkefna
* Getur veri√∞ varasamt a√∞ taka √° sig of m√∂rg dependancy

***

## Umr√¶√∞ur √≠ n√¶sta t√≠ma

Hverjir eru kostir og gallar NPM?

* [The Node.js Community Is Quietly Changing the Face of Open Source](http://caines.ca/blog/2013/04/13/the-node-dot-js-community-is-quietly-changing-the-face-of-open-source/) ‚Äì fr√° 2013
* [Rage-quit: Coder unpublished 17 lines of JavaScript and ‚Äúbroke the Internet‚Äù](https://arstechnica.com/information-technology/2016/03/rage-quit-coder-unpublished-17-lines-of-javascript-and-broke-the-internet/)
* [NPM & left-pad: Have We Forgotten How To Program?](http://www.haneycodes.net/npm-left-pad-have-we-forgotten-how-to-program/)
* [Code dependencies are the devil.](https://medium.freecodecamp.org/code-dependencies-are-the-devil-35ed28b556d)
* [I‚Äôm harvesting credit card numbers and passwords from your site. Here‚Äôs how.](https://hackernoon.com/im-harvesting-credit-card-numbers-and-passwords-from-your-site-here-s-how-9a8cb347c5b5)
