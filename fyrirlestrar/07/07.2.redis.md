# Fyrirlestur 7.2 ‚Äî redis
### Vefforritun 2 ‚Äî HBV403G
#### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## Hva√∞ er redis?

* [redis](https://redis.io/) er gagnataga geymsla √≠ minni ‚Äì in-memory data structure store
  - Ekki _relational_
  - _NoSQL_
* Sty√∞ur strengi, lista, set og fleiri t√Ωpur

***

## redis

* redis vinnur a√∞eins √≠ skyndiminni og er √æv√≠ mj√∂g hratt
* Getum tengt margar v√©lar saman og unni√∞ √æannig me√∞ miki√∞ af g√∂gnum
* H√¶gt a√∞ kveikja √° a√∞ g√∂gn s√©u vistu√∞ √° disk
* √ç okkar tilfelli munum vi√∞ nota redis fyrir hluti sem ‚Äûmega gleymast‚Äú

***

## redis

* redis er key-value store
  - Lyklar eru h√°stafan√¶mir
* Hlutir √≠ redis eru geymdir undir lykli
  - `SET user "foo"`
  - `GET user`

***

## redis

* Vi√∞ munum nota til a√∞:
  - √ötf√¶ra cache fyrir vefforritin okkar
  - Setja upp session store

***

## redis skipanir

redis hefur [margar skipanir](https://redis.io/commands) til a√∞ vinna me√∞ g√∂gn

* [`KEYS`](https://redis.io/commands/keys) skilar okkur √∂llum lyklum eftir _pattern_
  - Ekki til a√∞ nota √≠ st√¶rri forritum √æar sem √æetta er h√¶g a√∞ger√∞
* [`FLUSHALL`](https://redis.io/commands/flushall) ey√∞ir √∂llum lyklum √≠ gagnagrunni

***

## redis skipanir

* [`SET`](https://redis.io/commands/set) setur lykil me√∞ gildi, aukalega getum vi√∞ tilgreint hven√¶r gildi rennur √∫t, hentugt t.d. til a√∞ geyma afrit √≠ √°kve√∞inn t√≠ma
* [`GET`](https://redis.io/commands/get) s√¶kir gildi eftir lykli og skilar √æv√≠ e√∞a `nil` (`null`) ef √æa√∞ er ekki til
* [`DEL`](https://redis.io/commands/del) ey√∞ir lykli e√∞a lyklum

og [margar margar fleiri](https://redis.io/commands)

***

## redis uppsetning

* Mac
  - `brew install redis`
* Linux
  - https://redis.io/download
* Windows
  - Microsoft porta√∞i k√≥√∞a yfir √° Windows, _√¶tti_ a√∞ virka me√∞ [lei√∞beiningum](https://github.com/ServiceStack/redis-windows#option-3-running-microsofts-native-port-of-redis)

***

## redis-cli

`redis-cli` leyfir okkur a√∞ tengjast redis √æj√≥nustu og senda skipanir

Setjum "hello" lykil sem "world" sem rennur √∫t eftir 10 sek:

```bash
> redis-cli
127.0.0.1:6379> set hello world EX 10
OK
127.0.0.1:6379> get hello
"world"
```

***

## heroku redis

* Heroku b√≠√∞ur upp √° margar [mismunandi redis √æj√≥nustur](https://elements.heroku.com/search/addons?q=redis)
* √ûarf a√∞ sta√∞festa heroku a√∞gang me√∞ √æv√≠ a√∞ setja inn kreditkort til a√∞ geta n√Ωtt

---

## redis og node

* Notum [`redis`](https://github.com/NodeRedis/node_redis) til a√∞ tengjast redis √∫r node
* N√Ωtum `url` til a√∞ tilgreina hvar redis er, einsog connection string fyrir postgres
* Getum [nota√∞ `util.promisify`](https://github.com/NodeRedis/node_redis#native-promises) til a√∞ geta nota√∞ `async await` üéâ
* `client.quit()` √æegar vi√∞ erum h√¶tt, annars hangir client √° event loop
  - √ûurfum ekki √≠ express appi

***

```javascript
const client = redis.createClient({
  url: redisUrl
});
const setAsync =
  promisify(client.set).bind(client);

await asyncSet('hello', 'world', 'EX', 10);

client.quit();
```

***

## redis session store

[`connect-redis`](https://github.com/tj/connect-redis) leyfir okkur a√∞ nota redis sem session storage

```javascript
const RedisStore =
  require('connect-redis')(session);

app.use(session({
  // ...
  store: new RedisStore({ url: redisUrl }),
}));
```

***

## redis sem cache

* Getum (og munum!) nota redis sem cache fyrir forritin okkar
* Notum JSON me√∞ √æv√≠ a√∞ `stringify`a g√∂gn
* A√∞skiljum ‚Äûd√Ωra‚Äú partinn af forritinu fr√° cache

***

```javascript
const cached = fromCache(key)
if (cached) {
  return cached;
}
const result = expansiveCalculation();
cache(key, result, expires);

return result;
```

***

## Caching pattern

1. Athugum hvort vi√∞ eigum g√∂gn √≠ cache
2. Ef svo er, skilum cache
3. Framkv√¶mum d√Ωra √∫treikning
4. Setjum ni√∞urst√∂√∞u √≠ cache
5. Skilum ni√∞urst√∂√∞u
