# Fyrirlestur 6.2 ‚Äî Au√∞kenning 2

## Vefforritun 2 ‚Äî HBV403G

### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## B√∫a til notanda

* H√∂fum n√∫na kynnst √æv√≠ hvernig vi√∞ getum au√∞kennt notanda sem vi√∞ eigum til
* En hva√∞ me√∞ a√∞ b√∫a til okkar eigin?
* Ekki mikil vi√∞b√≥t...

***

## Notendaumsj√≥n

* √ûurfum a√∞ geyma notendur √° hentugum sta√∞
  - Vi√∞ munum nota postgres
* B√¶tum vi√∞ route sem leyfir notanda a√∞ skr√° sig, tekur a.m.k. vi√∞ notendaau√∞kenni og lykilor√∞i (`username` og `password`)
  - Getum h√¶glega skr√°√∞ auka uppl√Ωsingar um notanda √≠ lei√∞inni

***

## A√∞eins um notendan√∂fn

* A√∞ √°kve√∞a hva√∞ s√©u l√∂gleg notendan√∂fn er ekki jafn einfalt og ma√∞ur myndi √¶tla
* Notendan√∂fn innihalda stafi og √æa√∞ er til miki√∞ af st√∂fum
  - "üí©", "–ûÔΩåÔΩâ", "ÈªûÁúã" l√∂gleg?
* Alv√∂ru vandam√°l me√∞ t.d. phishing
  - [Creative usernames and Spotify account hijacking](https://labs.spotify.com/2013/06/18/creative-usernames/)

***

> Replace a semicolon (;) with a greek question mark (Õæ) in your friend&#39;s JavaScript and watch them pull their hair out over the syntax error

‚Äî[Ben Johnson (@benbjohnson), November 16, 2014](https://twitter.com/benbjohnson/status/533848879423578112)

***

## Gleymt lykilor√∞

* Seinasta p√∫sli√∞ √≠ √æv√≠ a√∞ setja saman _alv√∂ru_ notendaumsj√≥narkerfi er sta√∞festing √° notanda
  - Yfirleitt gert me√∞ t√∂lvup√≥st
* Getum √æ√° √∫tf√¶rt gleymt lykilor√∞ virkni
* F√∂rum ekki yfir

---

## Vef√æj√≥nustur og au√∞kenning

* √ûegar vi√∞ b√¶tum au√∞kenningu vi√∞ vef√æj√≥nusturnar okkar er √æa√∞ mj√∂g sjaldan gert me√∞ sessions
* Session skalast illa
  - √ûurfum a√∞ geyma uppl√Ωsingar einhverssta√∞ar √° vef√æj√≥n
  - Ef vi√∞ notum fleiri en einn vef√æj√≥n √æarf a√∞ deila √æessum uppl√Ωsingum
  - √ûurfum a√∞ fletta upp uppl√Ωsingum √≠ gagnageymslu til a√∞ f√° l√Ωsig√∂gn, t.d. hven√¶r session var b√∫i√∞ til
  - √ñryggish√¶ttur tengdar cookies og session

***

## Tokens

* Me√∞ √æv√≠ a√∞ nota _tokens_ sem eru undirrita√∞ir af vef√æj√≥n losnum vi√∞ m√∂rg af √æessum vandam√°lum
* Getum st√Ωrt √æv√≠ hva√∞a uppl√Ωsingar eru geymdar
* Au√∞velt a√∞ senda √° milli, t.d. fyrir _single sign-on_ kerfi

***

* G√∂gn sem vi√∞ viljum geyma eru sett saman me√∞ l√Ωsig√∂gnum og stillingum fyrir token
  - T.d. hven√¶r token rennur √∫t
* Vef√æj√≥nn undirritar me√∞ dulk√≥√∞unara√∞fer√∞ og f√∂ldum lykli
* Client f√¶r token og geymir, sendir me√∞ _hverri_ request √æar sem au√∞kenningar er krafist
  - Yfirleitt √≠ `Authorization` HTTP hausnum

---

## JWT

* [JSON Web Tokens](https://jwt.io/) er lei√∞ til a√∞ senda JSON hluti √° milli sta√∞a me√∞ vissu um a√∞ √æeim hafi ekki veri√∞ breytt
  - B√¶√∞i undirrita√∞a og dulk√≥√∞a√∞a
* Byggja √° √æv√≠ a√∞ base64 k√≥√∞a uppl√Ωsingar um token, base64 k√≥√∞a uppl√Ωsingar og undirrita me√∞ leyndarm√°li
* Sta√∞all hefur veri√∞ gagngr√Ωndur fyrir a√∞ vera ekki n√≥gu vel skilgreindur og √∂ruggur
  - [No Way, JOSE! Javascript Object Signing and Encryption is a Bad Standard That Everyone Should Avoid](https://paragonie.com/blog/2017/03/jwt-json-web-tokens-is-bad-standard-that-everyone-should-avoid)

***

## Noktun

* Notum til a√∞ vita a√∞ s√° sem heldur √° token hafi √° einhverjum t√≠mapunkti au√∞kennt sig gagnvart okkur
* Geymum **engar** vi√∞kv√¶mar uppl√Ωsingar √≠ token
* Stillum token √° a√∞ renna √∫t √° einhverjum t√≠mapunkti og l√°tum notanda √æar me√∞ aukenna sig aftur

---

## JWT, express og passport

* S√¶kjum [`passport-jwt`](https://github.com/themikenicholson/passport-jwt) til √æess a√∞ au√∞kenna me√∞ JWT gegnum passport
* Til a√∞ undirrita token notum vi√∞ [`jsonwebtoken`](https://github.com/auth0/node-jsonwebtoken)
* Svipa√∞ √æv√≠ a√∞ nota `passport-local`
  - √ûurfum ekki a√∞ serialize'a notanda og viljum ekki nota session

***

```javascript
const {
  Strategy,
  ExtractJwt
} = require('passport-jwt');

const jwtOptions = {
  jwtFromRequest: ExtractJwt
                    .fromAuthHeaderAsBearerToken(),
  secretOrKey: superSecret,
}
function strat(data, next) { ... }
passport.use(new Strategy(jwtOptions, strat));
```

***

## Login endapunktur

* √ötb√∫um endapunkt sem client notar til a√∞ au√∞kenna sig og f√° token
  - t.d. `/login`
* √ûar finnum vi√∞ notanda og sta√∞festum lykilor√∞
* √ûar til token rennur √∫t ver√∞ur √æa√∞ **jafngilt** √æv√≠ a√∞ hafa notendanafn og lykilor√∞ notanda
  - √ûarf a√∞ passa upp!

***

## Au√∞kenning

* Client mun senda token me√∞ _hverju_ request
* √ûurfum √æv√≠ alltaf a√∞ sta√∞festa token √≠ hvert skipti sem notandi bi√∞ur um eitthva√∞ sem krefst au√∞kenningar
  - Er token √≠ lagi? Stenst undirritun?
  - Er token √∫trunninn?
  - Fleiri athuganir sem vi√∞ g√¶tum vilja√∞ gera
